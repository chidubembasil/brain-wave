<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Brainwave</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .input-wrapper {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            user-select: none;
            font-size: 18px;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .toggle-password:hover {
            opacity: 1;
        }

        .password-strength {
            margin-top: 8px;
        }

        .strength-bar {
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-fill.weak {
            width: 33%;
            background: #ef4444;
        }

        .strength-fill.medium {
            width: 66%;
            background: #f59e0b;
        }

        .strength-fill.strong {
            width: 100%;
            background: #10b981;
        }

        .strength-text {
            font-size: 12px;
            font-weight: 600;
        }

        .strength-text.weak {
            color: #ef4444;
        }

        .strength-text.medium {
            color: #f59e0b;
        }

        .strength-text.strong {
            color: #10b981;
        }

        .password-requirements {
            margin-top: 10px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .requirement {
            font-size: 12px;
            color: #6b7280;
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .requirement.valid {
            color: #10b981;
        }

        .req-icon {
            font-size: 10px;
            font-weight: bold;
        }

        .requirement.valid .req-icon {
            color: #10b981;
        }

        .requirement.valid .req-icon::before {
            content: '‚úì';
        }

        .password-match {
            margin-top: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .password-match.match {
            color: #10b981;
        }

        .password-match.no-match {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="auth-logo">
                    <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" class="logo-img">
                        <rect x="0" y="0" width="40" height="40" rx="8" ry="8" fill="#fbbf24"/>
                        <text x="20" y="28" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#1e3a8a">B</text>
                    </svg>
                    <h1>BrainWave</h1>
                </div>
                <p>Create your account to start learning.</p>
            </div>
            
            <!-- Error Display -->
            <div id="errorDisplay" style="display: none; background: #fee; border: 1px solid #fcc; color: #c00; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>‚ö†Ô∏è Error:</strong> <span id="errorMessage"></span>
            </div>
            
            <form class="login-form" id="signupForm">
                <!-- Role Selection -->
                <div class="form-group">
                    <label>I am a:</label>
                    <div class="role-selection">
                        <label class="role-option">
                            <input type="radio" name="userRole" value="student" checked>
                            <span>Student</span>
                        </label>
                        <label class="role-option">
                            <input type="radio" name="userRole" value="parent">
                            <span>Parent</span>
                        </label>
                    </div>
                </div>

                <!-- Name Fields -->
                <div class="form-group">
                    <label for="firstName">First Name:</label>
                    <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name:</label>
                    <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" name="email" placeholder="Enter your email address" required>
                </div>

                <!-- Password -->
                <div class="form-group">
                    <label for="password">Password:</label>
                    <div class="input-wrapper">
                        <input type="password" id="password" name="password" placeholder="Enter your password" required>
                        <i class="toggle-password" id="togglePassword">üëÅÔ∏è</i>
                    </div>
                    <div class="password-strength" id="passwordStrength" style="display: none;">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <span class="strength-text" id="strengthText"></span>
                    </div>
                    <div class="password-requirements" id="passwordRequirements" style="display: none;">
                        <div class="requirement" id="req-length">
                            <span class="req-icon">‚óã</span> At least 8 characters
                        </div>
                        <div class="requirement" id="req-uppercase">
                            <span class="req-icon">‚óã</span> One uppercase letter
                        </div>
                        <div class="requirement" id="req-lowercase">
                            <span class="req-icon">‚óã</span> One lowercase letter
                        </div>
                        <div class="requirement" id="req-number">
                            <span class="req-icon">‚óã</span> One number
                        </div>
                        <div class="requirement" id="req-special">
                            <span class="req-icon">‚óã</span> One special character
                        </div>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <div class="input-wrapper">
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" required>
                        <i class="toggle-password" id="toggleConfirmPassword">üëÅÔ∏è</i>
                    </div>
                    <div class="password-match" id="passwordMatch" style="display: none;"></div>
                </div>

                <!-- Student Fields -->
                <div class="student-fields" id="studentFields">
                    <div class="form-group">
                        <label for="level">Academic Level:</label>
                        <select id="level" name="level" required>
                            <option value="">Select your level</option>
                            <option value="SS1">SS1</option>
                            <option value="SS2">SS2</option>
                            <option value="SS3">SS3</option>
                            <option value="Jambite">Jambite</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stream">Stream:</label>
                        <select id="stream" name="stream" required>
                            <option value="">Select your stream</option>
                            <option value="Science">Science</option>
                            <option value="Humanities">Humanities</option>
                            <option value="Business">Business</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="login-btn">Create Account</button>

                <!-- Terms and Conditions -->
                <div class="form-group" style="margin-top: 20px;">
                    <div style="display: flex; align-items: start; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <input type="checkbox" id="terms" name="terms" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;" required>
                        <label for="terms" style="margin: 0; font-size: 14px; cursor: pointer; color: #374151; line-height: 1.5; font-weight: 500;">
                            I agree to the <a href="terms-of-service.html" target="_blank" style="color: #1e3a8a; text-decoration: none; font-weight: 600;">Terms of Service</a> and <a href="privacy-policy.html" target="_blank" style="color: #1e3a8a; text-decoration: none; font-weight: 600;">Privacy Policy</a>
                        </label>
                    </div>
                    <span style="color: #ef4444; font-size: 12px; margin-top: 6px; display: none;" id="termsError">You must agree to the terms and conditions to continue</span>
                </div>
            </form>
            
            <div class="login-footer">
                <p>Already have an account? <a href="login.html">Sign in here</a></p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase functions at the top
        import { auth, db, createUserWithEmailAndPassword, sendEmailVerification, setDoc, doc, generateStudentCode, getBootcampExpiryDate, serverTimestamp } from './firebase-config.js';
        
        console.log('‚úÖ Firebase module loaded');

        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSignup);
        } else {
            initializeSignup();
        }

        function initializeSignup() {
            console.log('üöÄ Initializing signup page...');

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const password = document.getElementById('password');
            if (password.type === 'password') {
                password.type = 'text';
                this.textContent = 'üôà';
            } else {
                password.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
            const confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword.type === 'password') {
                confirmPassword.type = 'text';
                this.textContent = 'üôà';
            } else {
                confirmPassword.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // Password strength checker
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthIndicator = document.getElementById('passwordStrength');
            const requirementsBox = document.getElementById('passwordRequirements');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');

            if (password.length > 0) {
                strengthIndicator.style.display = 'block';
                requirementsBox.style.display = 'block';
                
                // Check requirements
                const hasLength = password.length >= 8;
                const hasUppercase = /[A-Z]/.test(password);
                const hasLowercase = /[a-z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

                // Update requirement indicators
                updateRequirement('req-length', hasLength);
                updateRequirement('req-uppercase', hasUppercase);
                updateRequirement('req-lowercase', hasLowercase);
                updateRequirement('req-number', hasNumber);
                updateRequirement('req-special', hasSpecial);

                // Calculate strength
                let strength = 0;
                if (hasLength) strength++;
                if (hasUppercase) strength++;
                if (hasLowercase) strength++;
                if (hasNumber) strength++;
                if (hasSpecial) strength++;

                strengthFill.className = 'strength-fill';
                strengthText.className = 'strength-text';

                if (strength <= 2) {
                    strengthFill.classList.add('weak');
                    strengthText.classList.add('weak');
                    strengthText.textContent = '‚ö†Ô∏è Weak password';
                } else if (strength <= 4) {
                    strengthFill.classList.add('medium');
                    strengthText.classList.add('medium');
                    strengthText.textContent = 'üõ°Ô∏è Medium strength';
                } else {
                    strengthFill.classList.add('strong');
                    strengthText.classList.add('strong');
                    strengthText.textContent = '‚úì Strong password';
                }
            } else {
                strengthIndicator.style.display = 'none';
                requirementsBox.style.display = 'none';
            }
        });

        function updateRequirement(id, isValid) {
            const element = document.getElementById(id);
            if (isValid) {
                element.classList.add('valid');
            } else {
                element.classList.remove('valid');
            }
        }

        // Confirm password matching
        document.getElementById('confirmPassword').addEventListener('input', function() {
            const password = document.getElementById('password').value;
            const confirmPassword = this.value;
            const matchIndicator = document.getElementById('passwordMatch');

            if (confirmPassword.length > 0) {
                matchIndicator.style.display = 'block';
                if (password === confirmPassword) {
                    matchIndicator.className = 'password-match match';
                    matchIndicator.textContent = '‚úì Passwords match';
                } else {
                    matchIndicator.className = 'password-match no-match';
                    matchIndicator.textContent = '‚úó Passwords do not match';
                }
            } else {
                matchIndicator.style.display = 'none';
            }
        });

        // Real-time terms checkbox validation
        document.getElementById('terms').addEventListener('change', function() {
            const termsError = document.getElementById('termsError');
            if (this.checked) {
                termsError.style.display = 'none';
                this.parentElement.style.borderColor = '#e5e7eb';
            }
        });

        // Handle role toggle
        const roleInputs = document.querySelectorAll('input[name="userRole"]');
        const studentFields = document.getElementById('studentFields');
        const levelField = document.getElementById('level');
        const streamField = document.getElementById('stream');
        
        roleInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.value === 'student') {
                    studentFields.style.display = 'block';
                    levelField.required = true;
                    streamField.required = true;
                } else {
                    studentFields.style.display = 'none';
                    levelField.required = false;
                    streamField.required = false;
                    levelField.value = '';
                    streamField.value = '';
                }
            });
        });
        
        // Function to generate mock data for new students
        function generateStudentMockData(studentData) {
            console.log('üìö Creating comprehensive mock data for:', studentData.name);
            
            const now = new Date();
            const futureDate = new Date(now);
            futureDate.setDate(futureDate.getDate() + 7);
            const nextWeek = new Date(now);
            nextWeek.setDate(nextWeek.getDate() + 7);
            const twoWeeks = new Date(now);
            twoWeeks.setDate(twoWeeks.getDate() + 14);
            
            // Generate quizzes and assignments
            const quizzes = [
                {
                    id: 'quiz_' + studentData.id + '_1',
                    type: 'quiz',
                    title: 'Quadratic Equations Quiz',
                    subject: 'Mathematics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '30',
                    totalMarks: 50,
                    questions: 15,
                    status: 'available',
                    description: 'Test your understanding of quadratic equations and their solutions',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                },
                {
                    id: 'quiz_' + studentData.id + '_2',
                    type: 'quiz',
                    title: 'Chemical Reactions Quiz',
                    subject: 'Chemistry',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '25',
                    totalMarks: 40,
                    questions: 12,
                    status: 'available',
                    description: 'Identify different types of chemical reactions and balance equations',
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                },
                {
                    id: 'quiz_' + studentData.id + '_3',
                    type: 'quiz',
                    title: 'Physics Mechanics Quiz',
                    subject: 'Physics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: nextWeek.toISOString(),
                    duration: '35',
                    totalMarks: 60,
                    questions: 18,
                    status: 'available',
                    description: 'Newton\'s laws, motion, and forces in physics',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                },
                {
                    id: 'assignment_' + studentData.id + '_1',
                    type: 'assignment',
                    title: 'Newton\'s Laws Assignment',
                    subject: 'Physics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '45',
                    totalMarks: 100,
                    status: 'available',
                    description: 'Solve problems involving Newton\'s three laws of motion',
                    instructions: 'Complete all 5 problems and show your work clearly',
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                },
                {
                    id: 'assignment_' + studentData.id + '_2',
                    type: 'assignment',
                    title: 'Cell Biology Assignment',
                    subject: 'Biology',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '40',
                    totalMarks: 80,
                    status: 'available',
                    description: 'Research and explain cellular processes',
                    instructions: 'Write a 1000-word essay on cell division',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                }
            ];
            
            // Generate mock exams
            const mockExams = [
                {
                    id: 'mock_' + studentData.id + '_1',
                    type: 'mock',
                    title: 'WAEC Mathematics Mock Exam',
                    subject: 'Mathematics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '120',
                    totalMarks: 100,
                    questions: 50,
                    status: 'available',
                    description: 'Comprehensive WAEC Mathematics practice test',
                    examType: 'WAEC',
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                },
                {
                    id: 'mock_' + studentData.id + '_2',
                    type: 'mock',
                    title: 'JAMB Physics Practice Test',
                    subject: 'Physics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    dueDate: futureDate.toISOString(),
                    duration: '90',
                    totalMarks: 100,
                    questions: 40,
                    status: 'available',
                    description: 'JAMB Physics mock examination',
                    examType: 'JAMB',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                }
            ];
            
            // Generate live classes
            const liveClasses = [
                {
                    id: 'live_' + studentData.id + '_1',
                    subject: 'Mathematics',
                    teacher: 'Dr. Sarah Johnson',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    date: now.toISOString(),
                    time: '10:00 AM',
                    status: 'live',
                    link: 'https://meet.google.com/sample-math-class',
                    topic: 'Calculus Integration Techniques',
                    duration: '60 minutes',
                    attendees: 45,
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                },
                {
                    id: 'live_' + studentData.id + '_2',
                    subject: 'Physics',
                    teacher: 'Prof. Michael Brown',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    date: futureDate.toISOString(),
                    time: '2:00 PM',
                    status: 'scheduled',
                    link: 'https://meet.google.com/sample-physics-class',
                    topic: 'Newton\'s Laws of Motion',
                    duration: '45 minutes',
                    attendees: 0,
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                }
            ];
            
            // Generate study materials
            const books = [
                {
                    id: 'book_' + studentData.id + '_1',
                    title: 'Advanced Mathematics for SS Students',
                    subject: 'Mathematics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    type: 'textbook',
                    format: 'PDF',
                    pages: 450,
                    size: '12.5 MB',
                    downloadUrl: '#',
                    description: 'Comprehensive mathematics textbook covering all SS topics',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                },
                {
                    id: 'book_' + studentData.id + '_2',
                    title: 'Physics Fundamentals',
                    subject: 'Physics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    type: 'textbook',
                    format: 'PDF',
                    pages: 380,
                    size: '9.8 MB',
                    downloadUrl: '#',
                    description: 'Essential physics concepts and problem-solving techniques',
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                }
            ];
            
            const videos = [
                {
                    id: 'video_' + studentData.id + '_1',
                    title: 'WAEC Mathematics Tutorial',
                    subject: 'Mathematics',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    type: 'video',
                    duration: '45:30',
                    views: 1250,
                    thumbnail: 'https://img.youtube.com/vi/sample-math/hqdefault.jpg',
                    videoUrl: 'https://youtube.com/watch?v=sample-math',
                    description: 'Complete WAEC mathematics preparation tutorial',
                    createdAt: now.toISOString(),
                    accessLevel: 'bootcamp'
                },
                {
                    id: 'video_' + studentData.id + '_2',
                    title: 'Chemistry Lab Techniques',
                    subject: 'Chemistry',
                    classLevel: studentData.classLevel,
                    stream: studentData.stream,
                    type: 'video',
                    duration: '32:15',
                    views: 890,
                    thumbnail: 'https://img.youtube.com/vi/sample-chem/hqdefault.jpg',
                    videoUrl: 'https://youtube.com/watch?v=sample-chem',
                    description: 'Essential chemistry laboratory techniques and safety',
                    createdAt: now.toISOString(),
                    accessLevel: 'paid'
                }
            ];
            
            // Save all mock data to localStorage
            localStorage.setItem('brainwave_quizs', JSON.stringify(quizzes));
            localStorage.setItem('brainwave_mocks', JSON.stringify(mockExams));
            localStorage.setItem('brainwave_live_classes', JSON.stringify(liveClasses));
            localStorage.setItem('brainwave_books', JSON.stringify(books));
            localStorage.setItem('brainwave_videos', JSON.stringify(videos));
            
            console.log('‚úÖ Mock data generated successfully:');
            console.log('- Quizzes & Assignments:', quizzes.length);
            console.log('- Mock Exams:', mockExams.length);
            console.log('- Live Classes:', liveClasses.length);
            console.log('- Books:', books.length);
            console.log('- Videos:', videos.length);
        }
        
        // Function to display errors on page
        function showError(message) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorDisplay.style.display = 'block';
            errorDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            document.getElementById('errorDisplay').style.display = 'none';
        }

        // Handle form submission - Wait for DOM to be ready
        const signupForm = document.getElementById('signupForm');
        
        if (!signupForm) {
            console.error('‚ùå Signup form not found!');
        } else {
            console.log('‚úÖ Signup form found, attaching event listener');
        }
        
        signupForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideError();
            
            console.log('üöÄ Form submitted!');
            console.log('Event default prevented:', e.defaultPrevented);
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const selectedRole = document.querySelector('input[name="userRole"]:checked').value;
            const termsCheckbox = document.getElementById('terms');
            const termsError = document.getElementById('termsError');
            
            console.log('üìù Form data:', { firstName, lastName, email, role: selectedRole });
            
            // Validate required fields
            if (!firstName || !lastName || !email || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            if (password.length < 8) {
                alert('Password must be at least 8 characters long');
                return;
            }
            
            // Validate terms and conditions
            if (!termsCheckbox.checked) {
                termsError.style.display = 'block';
                termsCheckbox.parentElement.style.borderColor = '#ef4444';
                alert('Please agree to the Terms of Service and Privacy Policy to continue');
                return;
            } else {
                termsError.style.display = 'none';
                termsCheckbox.parentElement.style.borderColor = '#e5e7eb';
            }
            
            // Validate student-specific fields
            if (selectedRole === 'student') {
                const level = document.getElementById('level').value;
                const stream = document.getElementById('stream').value;
                
                if (!level || !stream) {
                    alert('Please select your academic level and stream');
                    return;
                }
            }
            
            const submitBtn = document.querySelector('.login-btn');
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;
            
            try {
                console.log('üîÑ Starting account creation...');
                
                // Create user data
                const level = selectedRole === 'student' ? document.getElementById('level').value : '';
                const stream = selectedRole === 'student' ? document.getElementById('stream').value : '';
                
                console.log('üîê Creating Firebase Auth user...');
                
                // Create Firebase Authentication user
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Firebase user created:', user.uid);
                
                console.log('üìß Sending verification email...');
                
                // Send email verification with action code settings
                try {
                    const actionCodeSettings = {
                        url: window.location.origin + '/email-confirmation.html',
                        handleCodeInApp: false
                    };
                    await sendEmailVerification(user, actionCodeSettings);
                    console.log('‚úÖ Verification email sent to:', user.email);
                } catch (emailError) {
                    console.error('‚ùå Email verification failed:', emailError);
                    console.error('Error code:', emailError.code);
                    console.error('Error message:', emailError.message);
                    alert('‚ö†Ô∏è Warning: Could not send verification email. Error: ' + emailError.message);
                }
                
                console.log('üìÖ Calculating expiry date...');
                
                // Calculate expiry date for bootcamp (7 days from now)
                const expiryDate = getBootcampExpiryDate();
                
                console.log('üì¶ Preparing user data for Firestore...');
                
                // Prepare user data for Firestore (base data)
                const userData = {
                    name: `${firstName} ${lastName}`,
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    role: selectedRole,
                    plan: 'bootcamp',
                    status: 'bootcamp',
                    isPaid: false,
                    paymentStatus: 'bootcamp',
                    expiryDate: expiryDate,
                    locked: false,
                    accountLocked: false,
                    joinDate: serverTimestamp(),
                    bootcampStartDate: serverTimestamp(),
                    paidDate: null,
                    planHistory: [{
                        from: null,
                        to: 'bootcamp',
                        changedAt: new Date().toISOString(),
                        changedBy: 'user_signup'
                    }],
                    emailVerified: false,
                    verifiedAt: null,
                    userType: selectedRole === 'student' ? 'child' : 'parent',
                    classLevel: level || '',
                    stream: stream || '',
                    phone: '',
                    parentId: null,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                // Add role-specific fields
                if (selectedRole === 'student') {
                    userData.studentCode = generateStudentCode();
                } else if (selectedRole === 'parent') {
                    userData.childrenCount = 0;
                    userData.children = [];
                    userData.needsChildLinking = true;
                }
                
                console.log('üíæ Saving to Firestore...');
                console.log('User data to save:', userData);
                
                // Save user data to Firestore
                await setDoc(doc(db, 'users', user.uid), userData);
                console.log('‚úÖ User data saved to Firestore');
                
                // Save user session
                const userSession = {
                    uid: user.uid,
                    email: email,
                    name: userData.name,
                    role: selectedRole,
                    isLoggedIn: true
                };
                localStorage.setItem('currentUser', JSON.stringify(userSession));
                
                // Store email and role for confirmation page
                localStorage.setItem('pendingUserEmail', email);
                localStorage.setItem('pendingUserRole', selectedRole);
                
                // Store student code if student
                if (selectedRole === 'student') {
                    localStorage.setItem('pendingStudentCode', userData.studentCode);
                    console.log('üéì Student Code:', userData.studentCode);
                }
                
                // Update button to show success
                submitBtn.textContent = '‚úì Account Created!';
                submitBtn.style.background = '#10b981';
                
                console.log('‚úÖ Signup complete!');
                console.log('Current URL:', window.location.href);
                console.log('üîÑ Attempting redirect to email-confirmation.html...');
                
                // Try multiple redirect methods
                setTimeout(() => {
                    console.log('Redirect attempt 1: window.location.href');
                    window.location.href = 'email-confirmation.html';
                }, 100);
                
                setTimeout(() => {
                    console.log('Redirect attempt 2: window.location.replace');
                    window.location.replace('email-confirmation.html');
                }, 500);
                
                setTimeout(() => {
                    console.log('Redirect attempt 3: Full path');
                    window.location.href = window.location.origin + '/email-confirmation.html';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Signup error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                
                submitBtn.textContent = 'Create Account';
                submitBtn.disabled = false;
                
                // Handle specific Firebase errors
                let errorMsg = '';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'This email is already registered. Please login instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'Password is too weak. Please use a stronger password (min 8 characters).';
                } else if (error.code === 'permission-denied') {
                    errorMsg = 'Permission denied. Please check Firestore security rules in Firebase Console.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMsg = 'Network error. Please check your internet connection.';
                } else if (error.message.includes('fetch')) {
                    errorMsg = 'Cannot connect to Firebase. Make sure you are running from http://localhost:8080 (not file://)';
                } else {
                    errorMsg = 'Signup failed: ' + error.message;
                }
                
                showError(errorMsg);
                alert(errorMsg);
            }
        });
        
        // Password validation
        const password = document.getElementById('password');
        
        function validatePassword() {
            if (password.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity("Passwords don't match");
            } else {
                confirmPassword.setCustomValidity('');
            }
        }
        
        password.addEventListener('change', validatePassword);
        confirmPassword.addEventListener('keyup', validatePassword);
        
        } // End of initializeSignup function
    </script>
</body>
</html>